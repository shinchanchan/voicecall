<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Voice-to-Voice Translation | Tamil ‚Üî English</title>
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 1rem;
        }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .connection-setup {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .status-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .status-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }
        
        .status-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }
        
        .status-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .language-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .language-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }
        
        .language-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .mode-selector {
            display: flex;
            gap: 0.5rem;
        }
        
        .mode-btn {
            padding: 0.8rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .mode-btn.active {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            border-color: transparent;
        }
        
        .translation-controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .control-title {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .translation-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
        }
        
        .indicator.active {
            background: #2ed573;
            animation: pulse 1.5s infinite;
        }
        
        .indicator.listening {
            background: #ffa502;
        }
        
        .indicator.speaking {
            background: #3742fa;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .call-controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .input-group {
            display: flex;
            gap: 1rem;
        }
        
        input {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        button {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex: 1;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .secondary-btn {
            background: linear-gradient(to right, #576574, #8395a7);
        }
        
        .success-btn {
            background: linear-gradient(to right, #2ed573, #1dd1a1);
        }
        
        .voice-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .voice-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            min-height: 200px;
        }
        
        .voice-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .voice-content {
            height: 150px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .voice-text {
            margin-bottom: 0.8rem;
            padding: 0.8rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .voice-text.original {
            border-left: 4px solid #ff7e5f;
        }
        
        .voice-text.translated {
            border-left: 4px solid #2ed573;
        }
        
        .voice-text.received {
            border-left: 4px solid #ffa502;
        }
        
        .voice-text.spoken {
            border-left: 4px solid #3742fa;
        }
        
        .voice-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-bottom: 0.3rem;
        }
        
        .audio-status {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .voice-status {
                grid-template-columns: 1fr;
            }
            
            .language-setup {
                grid-template-columns: 1fr;
            }
            
            .mode-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Real Voice-to-Voice Translation</h1>
        <p class="subtitle">Tamil ‚Üî English | Speak & Hear Translations Aloud</p>
    </header>
    
    <div class="container">
        <div class="connection-setup">
            <div class="status-label">Your Connection ID</div>
            <div id="my-id" class="status-value" style="font-size: 1.5rem; margin: 0.5rem 0;">Generating...</div>
            <button class="success-btn" onclick="shareMyId()">üìã Copy My ID</button>
        </div>
        
        <div class="status-container">
            <div class="status-box">
                <div class="status-label">Connection Status</div>
                <div id="connection-status" class="status-value">Connecting...</div>
            </div>
            <div class="status-box">
                <div class="status-label">Translation Mode</div>
                <div id="translation-mode" class="status-value">Tamil ‚Üí English</div>
            </div>
            <div class="status-box">
                <div class="status-label">Call Status</div>
                <div id="call-status" class="status-value">No Call</div>
            </div>
        </div>
        
        <div class="language-setup">
            <div class="language-box">
                <div class="language-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 5.5V7H9V10H10C10.8 10 11.56 10.26 12.18 10.72C12.07 11.14 12 11.57 12 12C12 12.43 12.07 12.86 12.18 13.28C11.56 13.74 10.8 14 10 14H9V17H15V18.5L21 17V15L16 16.3V13.91C17.8 13.52 19 12.06 19 10.3C19 9.82 18.9 9.35 18.7 8.93L21 9ZM15 10C15.55 10 16 10.45 16 11C16 11.55 15.55 12 15 12C14.45 12 14 11.55 14 11C14 10.45 14.45 10 15 10ZM7 12C5.34 12 4 13.34 4 15C4 16.66 5.34 18 7 18C8.66 18 10 16.66 10 15C10 13.34 8.66 12 7 12Z" fill="currentColor"/>
                    </svg>
                    <span>You Speak</span>
                </div>
                <div class="mode-selector">
                    <button class="mode-btn active" onclick="setMyLanguage('ta')">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                    <button class="mode-btn" onclick="setMyLanguage('en')">English</button>
                </div>
            </div>
            
            <div class="language-box">
                <div class="language-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12.87 15.07L10.33 12.56L10.36 12.53C12.1 10.59 13.34 8.36 14.07 6H17V4H10V2H8V4H1V6H12.17C11.5 7.92 10.44 9.75 9 11.35C8.07 10.32 7.3 9.19 6.69 8H4.69C5.42 9.63 6.42 11.17 7.67 12.56L2.58 17.58L4 19L9 14L12.11 17.11L12.87 15.07ZM18.5 10H16.5L12 22H14L15.12 19H19.87L21 22H23L18.5 10ZM15.88 17L17.5 12.67L19.12 17H15.88Z" fill="currentColor"/>
                    </svg>
                    <span>Friend Speaks</span>
                </div>
                <div class="mode-selector">
                    <button class="mode-btn" onclick="setFriendLanguage('ta')">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                    <button class="mode-btn active" onclick="setFriendLanguage('en')">English</button>
                </div>
            </div>
        </div>
        
        <div class="translation-controls">
            <div class="control-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 15C13.6569 15 15 13.6569 15 12V5C15 3.34315 13.6569 2 12 2C10.3431 2 9 3.34315 9 5V12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M19 10V12C19 15.866 15.866 19 12 19C8.13401 19 5 15.866 5 12V10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 19V22" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>Voice-to-Voice Translation</span>
            </div>
            
            <div class="translation-status">
                <div class="indicator" id="translation-indicator"></div>
                <div id="translation-message">Set languages and start voice translation</div>
            </div>
            
            <div class="input-group">
                <button id="start-translation" onclick="startVoiceTranslation()">üé§ Start Voice Translation</button>
                <button id="stop-translation" onclick="stopVoiceTranslation()" disabled>‚èπÔ∏è Stop Translation</button>
                <button class="secondary-btn" onclick="testVoiceTranslation()">üß™ Test Voice</button>
            </div>
        </div>
        
        <div class="call-controls">
            <div class="input-group">
                <input type="text" id="remoteId" placeholder="Enter friend's ID to call">
                <button id="call-btn" onclick="startVoiceCall()">üìû Start Voice Call</button>
            </div>
            
            <div class="input-group">
                <button id="toggle-mic" onclick="toggleMicrophone()">üé§ Mute My Voice</button>
                <button class="secondary-btn" onclick="endCall()">üìû End Call</button>
            </div>
        </div>
        
        <div class="voice-status">
            <div class="voice-box">
                <div class="voice-header">
                    <span>Your Side</span>
                </div>
                <div class="voice-content" id="my-speech">
                    <div class="voice-text original">
                        <div class="voice-time">Ready</div>
                        <div>You will hear translated voice here</div>
                    </div>
                </div>
            </div>
            
            <div class="voice-box">
                <div class="voice-header">
                    <span>Friend's Side</span>
                </div>
                <div class="voice-content" id="friend-speech">
                    <div class="voice-text received">
                        <div class="voice-time">Ready</div>
                        <div>Friend will hear translated voice</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="audio-status">
            <div class="status-label">Voice Translation Status</div>
            <div id="audio-status">Start voice call and translation to hear spoken translations</div>
        </div>
    </div>

    <!-- Audio elements for voice playback -->
    <audio id="remoteAudio" autoplay></audio>
    <audio id="translationAudio" style="display: none;"></audio>

    <script>
        // ==================== COMPREHENSIVE TRANSLATION DICTIONARY ====================
        const translationDictionary = {
            // Basic Greetings & Responses
            '‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç': 'Hello', '‡Æµ‡Æ£‡Æï‡Øç‡Æï': 'Hi', '‡Æ®‡ÆÆ‡Æ∏‡Øç‡Æï‡Ææ‡Æ∞‡ÆÆ‡Øç': 'Namaste', 
            '‡Æ®‡Æ©‡Øç‡Æ±‡Æø': 'Thank you', '‡Æ®‡Æ©‡Øç‡Æ±‡Æø‡Æï‡Æ≥‡Øç': 'Thanks', '‡Æ∞‡Øä‡ÆÆ‡Øç‡Æ™ ‡Æ®‡Æ©‡Øç‡Æ±‡Æø': 'Thank you very much',
            '‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï': 'Welcome', '‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï': 'Sorry', '‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡ÆØ': 'Sorry', 
            '‡Æ™‡Æ∞‡Æµ‡Ææ‡ÆØ‡Æø‡Æ≤‡Øç‡Æ≤': "It's okay", '‡ÆÜ‡ÆÆ‡Ææ‡ÆÆ‡Øç': 'Yes', '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà': 'No', '‡Æö‡Æ∞‡Æø': 'Okay',
            
            // Questions
            '‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø': 'How', '‡Æé‡Æ©‡Øç‡Æ©': 'What', '‡Æé‡Æô‡Øç‡Æï‡Øá': 'Where', '‡ÆØ‡Ææ‡Æ∞‡Øç': 'Who',
            '‡Æè‡Æ©‡Øç': 'Why', '‡Æé‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ': 'When', '‡Æé‡Æ§‡Øç‡Æ§‡Æ©‡Øà': 'How many', 
            '‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç': 'How are you', '‡Æö‡Øå‡Æï‡Øç‡Æï‡Æø‡ÆØ‡ÆÆ‡Ææ': 'Are you fine',
            '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æé‡Æ©‡Øç‡Æ©': 'What is your name',
            
            // Pronouns & People
            '‡Æ®‡Ææ‡Æ©‡Øç': 'I', '‡Æ®‡ØÄ': 'You', '‡ÆÖ‡Æµ‡Æ∞‡Øç': 'He', '‡ÆÖ‡Æµ‡Æ≥‡Øç': 'She', 
            '‡Æ®‡Ææ‡Æô‡Øç‡Æï‡Æ≥‡Øç': 'We', '‡ÆÖ‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç': 'They', '‡Æé‡Æ≤‡Øç‡Æ≤‡Øã‡Æ∞‡ØÅ‡ÆÆ‡Øç': 'Everyone',
            '‡Æé‡Æ©‡Øç': 'My', '‡Æâ‡Æô‡Øç‡Æï': 'Your',
            
            // Family
            '‡ÆÖ‡Æ™‡Øç‡Æ™‡Ææ': 'Father', '‡ÆÖ‡ÆÆ‡Øç‡ÆÆ‡Ææ': 'Mother', '‡Æ§‡ÆÆ‡Øç‡Æ™‡Æø': 'Brother', 
            '‡Æ§‡Æô‡Øç‡Æï‡Øà': 'Sister', '‡ÆÆ‡Æ©‡Øà‡Æµ‡Æø': 'Wife', '‡Æï‡Æ£‡Æµ‡Æ©‡Øç': 'Husband',
            '‡ÆÆ‡Æï‡Æ©‡Øç': 'Son', '‡ÆÆ‡Æï‡Æ≥‡Øç': 'Daughter',
            
            // Common Nouns
            '‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç': 'Name', '‡Æµ‡ÆØ‡Æ§‡ØÅ': 'Age', '‡Æá‡Æü‡ÆÆ‡Øç': 'Place', '‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç': 'Time',
            '‡Æµ‡ØÄ‡Æü‡ØÅ': 'House', '‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø': 'School', '‡Æµ‡Øá‡Æ≤‡Øà': 'Work', 
            '‡Æö‡Ææ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ': 'Food', '‡Æ§‡Æ£‡Øç‡Æ£‡ØÄ‡Æ∞‡Øç': 'Water', '‡Æï‡Ææ‡Æ™‡Æø': 'Coffee', '‡Æü‡ØÄ': 'Tea',
            '‡Æ®‡Æï‡Æ∞‡ÆÆ‡Øç': 'City', '‡Æ®‡Ææ‡Æü‡ØÅ': 'Country',
            
            // Numbers
            '‡Æí‡Æ©‡Øç‡Æ±‡ØÅ': 'One', '‡Æá‡Æ∞‡Æ£‡Øç‡Æü‡ØÅ': 'Two', '‡ÆÆ‡ØÇ‡Æ©‡Øç‡Æ±‡ØÅ': 'Three', '‡Æ®‡Ææ‡Æ©‡Øç‡Æï‡ØÅ': 'Four',
            '‡Æê‡Æ®‡Øç‡Æ§‡ØÅ': 'Five', '‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ': 'Ten', '‡Æá‡Æ∞‡ØÅ‡Æ™‡Æ§‡ØÅ': 'Twenty', '‡Æ®‡ØÇ‡Æ±‡ØÅ': 'Hundred',
            
            // Time
            '‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ': 'Now', '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ': 'Today', '‡Æ®‡Øá‡Æ±‡Øç‡Æ±‡ØÅ': 'Yesterday', 
            '‡Æ®‡Ææ‡Æ≥‡Øà': 'Tomorrow', '‡Æï‡Ææ‡Æ≤‡Øà': 'Morning', '‡ÆÆ‡Ææ‡Æ≤‡Øà': 'Evening', '‡Æá‡Æ∞‡Æµ‡ØÅ': 'Night',
            
            // Common Adjectives & Verbs
            '‡Æ®‡Æ≤‡Øç‡Æ≤': 'Good', '‡ÆÆ‡Øã‡Æö‡ÆÆ‡Ææ‡Æ©': 'Bad', '‡Æ™‡ØÜ‡Æ∞‡Æø‡ÆØ': 'Big', '‡Æö‡Æø‡Æ±‡Æø‡ÆØ': 'Small',
            '‡ÆÖ‡Æ¥‡Æï‡Ææ‡Æ©': 'Beautiful', '‡Æö‡ØÇ‡Æü‡Ææ‡Æ©': 'Hot', '‡Æï‡ØÅ‡Æ≥‡Æø‡Æ∞‡Ææ‡Æ©': 'Cold',
            '‡Æ™‡Øã': 'Go', '‡Æµ‡Ææ': 'Come', '‡Æö‡Ææ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡ØÅ': 'Eat', '‡Æï‡ØÅ‡Æü‡Æø': 'Drink',
            '‡Æ§‡ØÇ‡Æô‡Øç‡Æï‡ØÅ': 'Sleep', '‡Æ™‡Ææ‡Æ∞‡Øç': 'See', '‡Æï‡Øá‡Æ≥‡Øç': 'Listen', '‡Æ™‡Øá‡Æö‡ØÅ': 'Speak',
            '‡Æµ‡Ææ‡Æô‡Øç‡Æï': 'Buy', '‡Æï‡Øä‡Æü‡ØÅ': 'Give',

            // Reverse mapping for English to Tamil
            'hello': '‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç', 'hi': '‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç', 'thank you': '‡Æ®‡Æ©‡Øç‡Æ±‡Æø',
            'thanks': '‡Æ®‡Æ©‡Øç‡Æ±‡Æø‡Æï‡Æ≥‡Øç', 'sorry': '‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï', 'yes': '‡ÆÜ‡ÆÆ‡Ææ‡ÆÆ‡Øç',
            'no': '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà', 'okay': '‡Æö‡Æ∞‡Æø', 'how': '‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø', 'what': '‡Æé‡Æ©‡Øç‡Æ©',
            'where': '‡Æé‡Æô‡Øç‡Æï‡Øá', 'who': '‡ÆØ‡Ææ‡Æ∞‡Øç', 'why': '‡Æè‡Æ©‡Øç', 'when': '‡Æé‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ',
            'i': '‡Æ®‡Ææ‡Æ©‡Øç', 'you': '‡Æ®‡ØÄ‡Æô‡Øç‡Æï', 'he': '‡ÆÖ‡Æµ‡Æ∞‡Øç', 'she': '‡ÆÖ‡Æµ‡Æ≥‡Øç',
            'we': '‡Æ®‡Ææ‡Æô‡Øç‡Æï‡Æ≥‡Øç', 'they': '‡ÆÖ‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç', 'name': '‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç', 'age': '‡Æµ‡ÆØ‡Æ§‡ØÅ',
            'place': '‡Æá‡Æü‡ÆÆ‡Øç', 'time': '‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç', 'house': '‡Æµ‡ØÄ‡Æü‡ØÅ', 'school': '‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø',
            'work': '‡Æµ‡Øá‡Æ≤‡Øà', 'food': '‡Æö‡Ææ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ', 'water': '‡Æ§‡Æ£‡Øç‡Æ£‡ØÄ‡Æ∞‡Øç', 'coffee': '‡Æï‡Ææ‡Æ™‡Æø',
            'good': '‡Æ®‡Æ≤‡Øç‡Æ≤', 'bad': '‡ÆÆ‡Øã‡Æö‡ÆÆ‡Ææ‡Æ©', 'big': '‡Æ™‡ØÜ‡Æ∞‡Æø‡ÆØ', 'small': '‡Æö‡Æø‡Æ±‡Æø‡ÆØ',
            'beautiful': '‡ÆÖ‡Æ¥‡Æï‡Ææ‡Æ©', 'hot': '‡Æö‡ØÇ‡Æü‡Ææ‡Æ©', 'cold': '‡Æï‡ØÅ‡Æ≥‡Æø‡Æ∞‡Ææ‡Æ©',
            'go': '‡Æ™‡Øã', 'come': '‡Æµ‡Ææ', 'eat': '‡Æö‡Ææ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡ØÅ', 'drink': '‡Æï‡ØÅ‡Æü‡Æø',
            'sleep': '‡Æ§‡ØÇ‡Æô‡Øç‡Æï‡ØÅ', 'see': '‡Æ™‡Ææ‡Æ∞‡Øç', 'listen': '‡Æï‡Øá‡Æ≥‡Øç', 'speak': '‡Æ™‡Øá‡Æö‡ØÅ',
            'buy': '‡Æµ‡Ææ‡Æô‡Øç‡Æï', 'give': '‡Æï‡Øä‡Æü‡ØÅ'
        };

        // ==================== APPLICATION STATE ====================
        let peer = null;
        let peerId = null;
        let currentCall = null;
        let dataConnection = null;
        let localStream = null;
        let recognition = null;
        let isTranslating = false;
        let myLanguage = 'ta';  // Default: Tamil
        let friendLanguage = 'en'; // Default: English
        let isMicrophoneMuted = false;

        // ==================== PEERJS CONNECTION ====================
        function initializePeerJS() {
            try {
                peerId = 'User_' + Math.random().toString(36).substring(2, 8).toUpperCase();
                
           peer = new Peer(peerId, {
    host: '0.peerjs.com', // public server
    port: 443,
    path: '/',
    secure: true,
    config: {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            {
                urls: 'turn:numb.viagenie.ca',
                credential: 'muazkh',
                username: 'webrtc@live.com'
            }
        ]
    }
});

                peer.on('open', (id) => {
                    document.getElementById('my-id').textContent = id;
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').style.color = '#2ed573';
                });

                peer.on('error', (err) => {
                    console.error('PeerJS error:', err);
                    document.getElementById('connection-status').textContent = 'Local Mode';
                });

                // Handle incoming calls
                peer.on('call', async (call) => {
                    try {
                        if (!localStream) {
                            localStream = await navigator.mediaDevices.getUserMedia({ 
                                audio: true, video: false 
                            });
                        }
                        
                        call.answer(localStream);
                        currentCall = call;
                        
                        call.on('stream', (remoteStream) => {
                            document.getElementById('remoteAudio').srcObject = remoteStream;
                            document.getElementById('call-status').textContent = 'Call Connected';
                            document.getElementById('audio-status').textContent = 'Voice call active - You can hear each other';
                        });
                        
                    } catch (error) {
                        console.error('Error answering call:', error);
                    }
                });

                // Handle data connections for translations
                peer.on('connection', (conn) => {
                    dataConnection = conn;
                    conn.on('data', (data) => {
                        if (data.type === 'voice_translation') {
                            // Friend sent a translation - speak it aloud
                            handleIncomingVoiceTranslation(data);
                        }
                    });
                });

            } catch (error) {
                console.error('Error initializing PeerJS:', error);
                document.getElementById('my-id').textContent = 'Local-' + peerId;
                document.getElementById('connection-status').textContent = 'Local Mode';
            }
        }

        // ==================== VOICE-TO-VOICE TRANSLATION ENGINE ====================
        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported. Please use Chrome or Edge.');
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = myLanguage === 'ta' ? 'ta-IN' : 'en-US';

            recognition.onstart = () => {
                isTranslating = true;
                updateTranslationUI('listening', 'üé§ Listening... Speak now');
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let confidence = 0;

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        confidence = Math.max(confidence, event.results[i][0].confidence);
                    }
                }

                if (finalTranscript) {
                    processVoiceTranslation(finalTranscript, confidence);
                }
            };

            recognition.onerror = (event) => {
                if (event.error !== 'aborted') {
                    updateTranslationUI('error', `Error: ${event.error}`);
                }
                stopVoiceTranslation();
            };

            recognition.onend = () => {
                if (isTranslating) {
                    setTimeout(() => {
                        if (isTranslating && recognition) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.error('Error restarting recognition:', e);
                            }
                        }
                    }, 100);
                }
            };

            return true;
        }

        function processVoiceTranslation(originalText, confidence) {
            // Display original speech
            addSpeechMessage('my-speech', `You: ${originalText}`, 'original', confidence);
            
            // Translate the text
            const translatedText = translateText(originalText, myLanguage, friendLanguage);
            
            // Display translation
            addSpeechMessage('my-speech', `Translated: ${translatedText}`, 'translated');
            
            // SPEAK THE TRANSLATION ALOUD
            speakTranslationAloud(translatedText, friendLanguage);
            
            // Send to friend so they can see the translation
            if (dataConnection && dataConnection.open) {
                dataConnection.send({
                    type: 'voice_translation',
                    original: originalText,
                    translated: translatedText,
                    fromLanguage: myLanguage,
                    toLanguage: friendLanguage,
                    timestamp: new Date().toISOString()
                });
            }
            
            updateTranslationUI('translated', `‚úÖ Translated & Spoken (${Math.round(confidence * 100)}% confidence)`);
        }

        function handleIncomingVoiceTranslation(data) {
            // Display friend's original speech
            addSpeechMessage('friend-speech', `Friend: ${data.original}`, 'received');
            
            // Display translation
            addSpeechMessage('friend-speech', `Translated: ${data.translated}`, 'translated');
            
            // SPEAK THE TRANSLATION ALOUD (from friend's speech)
            const translationForMe = translateText(data.original, data.fromLanguage, myLanguage);
            speakTranslationAloud(translationForMe, myLanguage);
            
            document.getElementById('audio-status').textContent = 'Speaking translation...';
        }

        function speakTranslationAloud(text, language) {
            if (!('speechSynthesis' in window)) {
                console.log('Text-to-speech not supported');
                return;
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            utterance.lang = language === 'ta' ? 'ta-IN' : 'en-US';

            // Show speaking indicator
            updateTranslationUI('speaking', 'üîä Speaking translation...');

            utterance.onstart = () => {
                document.getElementById('audio-status').textContent = 'Speaking translation aloud...';
            };

            utterance.onend = () => {
                updateTranslationUI('translated', '‚úÖ Translation spoken');
                document.getElementById('audio-status').textContent = 'Ready for next translation';
            };

            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                updateTranslationUI('translated', '‚úÖ Translation ready');
                document.getElementById('audio-status').textContent = 'Translation ready';
            };

            window.speechSynthesis.speak(utterance);
        }

        function translateText(text, fromLang, toLang) {
            let translated = text;
            
            if (fromLang === 'ta' && toLang === 'en') {
                // Tamil to English
                for (const [tamil, english] of Object.entries(translationDictionary)) {
                    if (tamil.length > 2) {
                        const regex = new RegExp('\\b' + tamil + '\\b', 'g');
                        translated = translated.replace(regex, english);
                    }
                }
            } else if (fromLang === 'en' && toLang === 'ta') {
                // English to Tamil
                const words = translated.toLowerCase().split(/\s+/);
                for (const word of words) {
                    if (translationDictionary[word] && word.length > 2) {
                        const regex = new RegExp('\\b' + word + '\\b', 'gi');
                        translated = translated.replace(regex, translationDictionary[word]);
                    }
                }
            }
            
            return translated !== text ? translated : text;
        }

        // ==================== UI CONTROLS ====================
        function setMyLanguage(lang) {
            myLanguage = lang;
            document.querySelectorAll('.language-box:first-child .mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateTranslationModeDisplay();
            
            if (isTranslating) {
                stopVoiceTranslation();
                setTimeout(startVoiceTranslation, 500);
            }
        }

        function setFriendLanguage(lang) {
            friendLanguage = lang;
            document.querySelectorAll('.language-box:last-child .mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateTranslationModeDisplay();
        }

        function updateTranslationModeDisplay() {
            const myLangText = myLanguage === 'ta' ? 'Tamil' : 'English';
            const friendLangText = friendLanguage === 'ta' ? 'Tamil' : 'English';
            document.getElementById('translation-mode').textContent = 
                `${myLangText} ‚Üí ${friendLangText}`;
        }

        function startVoiceTranslation() {
            if (!recognition && !initializeSpeechRecognition()) {
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    stream.getTracks().forEach(track => track.stop());
                    recognition.lang = myLanguage === 'ta' ? 'ta-IN' : 'en-US';
                    recognition.start();
                    document.getElementById('audio-status').textContent = 'Voice translation active - Speak now';
                })
                .catch(err => {
                    alert('Microphone access required for voice translation.');
                });
        }

        function stopVoiceTranslation() {
            if (recognition && isTranslating) {
                isTranslating = false;
                try {
                    recognition.stop();
                } catch (e) {
                    console.error('Error stopping recognition:', e);
                }
                updateTranslationUI('stopped', 'Voice translation stopped');
                document.getElementById('audio-status').textContent = 'Voice translation stopped';
            }
        }

        async function startVoiceCall() {
            const remoteId = document.getElementById('remoteId').value.trim();
            if (!remoteId) {
                alert('Please enter your friend\'s ID');
                return;
            }

            try {
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, video: false 
                    });
                }

                const call = peer.call(remoteId, localStream);
                currentCall = call;

                call.on('stream', (remoteStream) => {
                    document.getElementById('remoteAudio').srcObject = remoteStream;
                    document.getElementById('call-status').textContent = 'Call Connected';
                    document.getElementById('audio-status').textContent = 'Voice call active - You can hear each other';
                });

                call.on('close', () => {
                    document.getElementById('call-status').textContent = 'Call Ended';
                    document.getElementById('audio-status').textContent = 'Call ended';
                    currentCall = null;
                });

                // Setup data connection for translations
                dataConnection = peer.connect(remoteId);
                dataConnection.on('open', () => {
                    console.log('Data connection for voice translations established');
                });

            } catch (error) {
                console.error('Error starting call:', error);
                alert('Failed to start voice call: ' + error.message);
            }
        }

        function toggleMicrophone() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isMicrophoneMuted = !audioTracks[0].enabled;
                document.getElementById('toggle-mic').textContent = 
                    isMicrophoneMuted ? 'üé§ Unmute My Voice' : 'üé§ Mute My Voice';
            }
        }

        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
                document.getElementById('call-status').textContent = 'Call Ended';
                document.getElementById('audio-status').textContent = 'Call ended';
            }
        }

        function shareMyId() {
            const myId = document.getElementById('my-id').textContent;
            navigator.clipboard.writeText(myId).then(() => {
                alert('Your ID copied to clipboard: ' + myId + '\n\nShare this with your friend for voice translation!');
            });
        }

        function testVoiceTranslation() {
            const testPhrases = {
                'ta': ['‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç', '‡Æ®‡Æ©‡Øç‡Æ±‡Æø', '‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç', '‡Æé‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æ∞‡Ææ‡Æú‡Øç'],
                'en': ['Hello', 'Thank you', 'How are you', 'My name is Raj']
            };

            const phrases = testPhrases[myLanguage] || testPhrases.ta;
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            
            // Simulate voice translation
            addSpeechMessage('my-speech', `You: ${randomPhrase}`, 'original', 0.9);
            const translatedText = translateText(randomPhrase, myLanguage, friendLanguage);
            addSpeechMessage('my-speech', `Translated: ${translatedText}`, 'translated');
            
            // SPEAK the translation aloud
            speakTranslationAloud(translatedText, friendLanguage);
            
            document.getElementById('audio-status').textContent = 'Speaking test translation...';
        }

        function updateTranslationUI(state, message) {
            const indicator = document.getElementById('translation-indicator');
            const messageEl = document.getElementById('translation-message');
            const startBtn = document.getElementById('start-translation');
            const stopBtn = document.getElementById('stop-translation');

            indicator.className = 'indicator';
            messageEl.textContent = message;

            switch(state) {
                case 'listening':
                    indicator.classList.add('active', 'listening');
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    break;
                case 'speaking':
                    indicator.classList.add('active', 'speaking');
                    break;
                case 'translated':
                    indicator.classList.add('active');
                    break;
                case 'stopped':
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    break;
                case 'error':
                    indicator.style.background = '#ff4757';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    break;
            }
        }

        function addSpeechMessage(containerId, text, type, confidence = 1) {
            const container = document.getElementById(containerId);
            const messageClass = `voice-text ${type}`;
            
            if (container.children.length > 6) {
                container.removeChild(container.children[0]);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = messageClass;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'voice-time';
            timeDiv.textContent = `${new Date().toLocaleTimeString()}`;
            
            const textDiv = document.createElement('div');
            textDiv.textContent = text;
            
            messageDiv.appendChild(timeDiv);
            messageDiv.appendChild(textDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializePeerJS();
            updateTranslationModeDisplay();
        });
    </script>
</body>
</html>
